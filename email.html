<!doctype html>
<html lang="en">
<head>
    <title>Quick Email</title>
    <meta charset="utf-8">
    <script src="//caja.appspot.com/caja.js"></script>
    <link href="static/css/email.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        {{range $index, $message := .Messages}}
        <div class="row">
            <div class="col-md-4">
                <span class="sender">{{$message.From}}</span>
                <span class="timestamp">{{$message.Header.Get "Date"}}</span>
            </div>
            <div class="col-md-8">
                <a href="{{$message.GmailLink}}">View this message in gmail</a>
            </div>
        </div>
        <div class="row">
            {{if .TextBody}}
            <div id="textPlain{{$index}}">
                <pre style="word-wrap: break-word; white-space: pre-wrap;">{{mailstrip .TextBody}}</pre>
            </div>
            {{end}}
            <div id="guest{{$index}}">
            </div>
        </div>
        {{else}}
        <div class="row text-center" style="padding-top:40px">
            <a href="{{.AuthURL}}" class="btn btn-default">Check my mail</a>
        </div>
        {{end}}
        {{if .Messages}}
            {{with index .Messages 0}}
        <form action="archive" method="post">
            <div class="row">
                <button type="sumbit" class="btn btn-default btn-lg">Archive</button>
            </div>
            <input type="hidden" name="thrid" value="{{.Thrid}}"></input>
        </form>
        <form action="send" method="post">
            <div class="row">
                <textarea name="mail-text" style="width:90%; margin:auto; height:60px;"></textarea>
            </div>
            <div class="row">
                <button type="sumbit" class="btn btn-default btn-lg">Send</button>
            </div>
                {{range .Recipients}}
        <input type="hidden" name="recipients" value="{{.}}"></input>
                {{end}}
                {{range .NamedRecipients}}
        <input type="hidden" name="named-recipients" value="{{.}}"></input>
                {{end}}
        <input type="hidden" name="subject" value="{{.Header.Get "Subject"}}"></input>
            {{end}}
        <input type="hidden" name="check" value="{{.CheckValue}}"></input>
        </form>
        {{end}}
    </div>
    <script>
        caja.initialize({
            cajaServer: 'https://caja.appspot.com/',
            debug: true
        });
        {{range $index, $message := .Messages}}
        {{if $message.BodyLink}}
        caja.load(document.getElementById('guest{{$index}}'), undefined, function(frame) {
            frame.code('{{$message.BodyLink}}', 'text/html')
            .run(function(){
                var node = document.getElementById('textPlain{{$index}}');
                node.parentNode.removeChild(node);
            });
        });
        {{end}}
        {{end}}
    </script>
</body>
</html>
